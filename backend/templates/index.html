<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OwnGPT Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body { font-family: sans-serif; margin: 0; padding: 0; }
      #chat { max-width: 600px; margin: auto; padding: 1rem; }
      #messages { border: 1px solid #ccc; height: 60vh; overflow-y: auto; padding: 0.5rem; }
      .message { margin-bottom: 1rem; }
      .user { font-weight: bold; }
      #controls { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
      textarea { flex: 1; }
      button { padding: 0.5rem 1rem; }
    </style>
  </head>
  <body>
    <div id="chat">
      <div id="messages"></div>
      <div id="controls">
        <textarea id="input" rows="2"></textarea>
        <button id="send">Send</button>
        <button id="stop" disabled>Stop</button>
      </div>
    </div>

    <script>
      const API_KEY = "{{ api_key }}";
      const MODEL = "{{ model }}";
      const messagesDiv = document.getElementById('messages');
      const input = document.getElementById('input');
      const sendBtn = document.getElementById('send');
      const stopBtn = document.getElementById('stop');
      let controller;

      function appendMessage(role, content) {
        const div = document.createElement('div');
        div.className = 'message';
        const header = document.createElement('div');
        header.className = 'user';
        header.textContent = role;
        const body = document.createElement('div');
        body.innerHTML = marked.parse(content);
        div.appendChild(header);
        div.appendChild(body);
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      async function sendMessage() {
        const content = input.value.trim();
        if (!content) return;
        appendMessage('User', content);
        input.value = '';
        controller = new AbortController();
        stopBtn.disabled = false;
        const payload = { model: MODEL, messages: [{ role: 'user', content }] };
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-own-key': API_KEY,
          },
          body: JSON.stringify({ messages: [{ role: 'user', content }] }),
          signal: controller.signal,
        });
        const reader = response.body.getReader();
        let partial = '';
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          partial += new TextDecoder().decode(value);
          const lines = partial.split('\n');
          partial = lines.pop();
          for (const line of lines) {
            if (line.trim()) {
              appendMessage('Assistant', line);
            }
          }
        }
        stopBtn.disabled = true;
      }

      sendBtn.onclick = sendMessage;
      stopBtn.onclick = () => {
        if (controller) controller.abort();
        stopBtn.disabled = true;
      };
    </script>
  </body>
</html>

